{% extends "base.html" %}

{% block title %}Add Task{% endblock %}

{% block content %}
<h1 class="text-center">Add New Task</h1>
    <form action="{{ url_for('add_task') }}" method="POST" class="mx-auto" style="max-width: 600px;" enctype="multipart/form-data">
    <div class="mb-3">
        <label for="title" class="form-label">Task Title</label>
        <input type="text" name="title" class="form-control" required>
    </div>
    <div class="mb-3">
        <label for="description" class="form-label">Task Description</label>
        <textarea name="description" class="form-control" required></textarea>
    </div>
    <div class="mb-3">
        <label for="task_date" class="form-label">Task Date</label>
        <input type="date" name="task_date" class="form-control" required>
    </div>
    <div class="mb-3">
        <label for="company" class="form-label">Company</label>
        <select name="company_id" id="company" class="form-control" required>
            <option value="">Select Company</option>
            {% for company in companies %}
                <option value="{{ company[0] }}">{{ company[1] }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <label for="branch" class="form-label">Branch</label>
        <select name="branch_id" id="branch" class="form-control" required>
            <option value="">Select Branch</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="section" class="form-label">Section</label>
        <select name="section_id" id="section" class="form-control" required>
            <option value="">Select Section</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="file" class="form-label">Attach File</label>
        <input type="file" name="file" class="form-control">
    </div>
    <div class="mb-3">
        <label for="assigned_user" class="form-label">Assign To</label>
        <select name="assigned_user_id" id="assigned_user" class="form-control" required>
            <option value="">Select User</option>
            {% for user in users %}
                <option value="{{ user[0] }}">{{ user[1] }} ({{ user[2] }})</option> <!-- Shows username and email -->
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <label for="notes" class="form-label">Notes</label>
        <textarea name="notes" class="form-control"></textarea>
    </div>
    <button type="submit" class="btn btn-success w-100">Add Task</button>
</form>

<!-- JavaScript for handling dynamic branch and section selection -->
<script>
    document.getElementById('company').addEventListener('change', function() {
        const companyId = this.value;
        if (!companyId) {
            return;  // If no company is selected, do nothing
        }

        fetch(`/get_branches/${companyId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to fetch branches");
                }
                return response.json();
            })
            .then(data => {
                let branchSelect = document.getElementById('branch');
                branchSelect.innerHTML = '<option value="">Select Branch</option>';
                data.branches.forEach(branch => {
                    branchSelect.innerHTML += `<option value="${branch.id}">${branch.name}</option>`;
                });

                // Reset sections when the company changes
                document.getElementById('section').innerHTML = '<option value="">Select Section</option>';
            })
            .catch(error => {
                console.error('Error fetching branches:', error);
                alert('Failed to load branches. Please try again.');
            });
    });

    document.getElementById('branch').addEventListener('change', function() {
        const branchId = this.value;
        if (!branchId) {
            return;  // If no branch is selected, do nothing
        }

        fetch(`/get_sections/${branchId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to fetch sections");
                }
                return response.json();
            })
            .then(data => {
                let sectionSelect = document.getElementById('section');
                sectionSelect.innerHTML = '<option value="">Select Section</option>';
                data.sections.forEach(section => {
                    sectionSelect.innerHTML += `<option value="${section.id}">${section.name}</option>`;
                });
            })
            .catch(error => {
                console.error('Error fetching sections:', error);
                alert('Failed to load sections. Please try again.');
            });
    });
</script>

{% endblock %}
